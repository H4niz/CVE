> A Buffer Overflow vulnerability exists in the latest version of
> Miniftpd in the do_retr function in ftpproto.c
>
> ------------------------------------------
>
> [Additional Information]
> #Author: h4niz from 1nv1cta team, HPT CyberSecurity Center
>
> #Submit date: 25/08/2021
> #Target: Miniftpd
> #Source: https://github.com/Gabe-commiter/Miniftpd
> #Description:
>  I found a issue, that can trigger buffer overflow on your application. The issue exists on do_retr() function (from line 706 to 791) on ftpproto.c
>
>  At glance, we can see you defined char arg{MAX_ARG]; , it's not problem, however, when you use sprintf() on line 718 and 721, they trigger bufferoverflow.
>
>  typedef struct session
>  {
>  /*
>   Defined on common.h
>    #define MAX_COMMAND_LINE 1024
>    #define MAX_COMMAND 32
>    #define MAX_ARG     1024
>
>    #define MAX_BUFFER_SIZE 1024
>  */
>
>  #define MAX_BUFFER_SIZE 1024
>   uid_t    uid;
>   int ctrl_fd;//     oe 
>   char cmdline{MAX_COMMAND_LINE];
>   char cmd{MAX_COMMAND];
>   char arg{MAX_ARG];
>  ....
>   <truncated>
>  ....
>  }session_t;
>  static void do_retr(session_t *sess)
>  {
>   <truncated>
>  ....
>   char buf{MAX_BUFFER_SIZE] = {0}; // Defined buffer called buf with MAX_BUFFER_SIZE length
>   //2       ae   
>   if(sess->is_ascii)
>  // trigger the buffer overflow because length of sess->arg is defined 1024 length,
>  // in order that, when sprintf is executed, the buffer `buf` can be write total  len("Opening ASCII mode data connection for ") + MAX_BUFFER_SIZE + len(" (%ld bytes)")
>    sprintf(buf,  "Opening ASCII mode data connection for %s (%ld bytes)", sess->arg, sbuf.st_size);//Ascii
>   else
>  // trigger the buffer overflow because length of sess->arg is defined 1024 length,
>  // in order that, when sprintf is executed, the buffer `buf` can be write total  len("Opening ASCII mode data connection for ") + MAX_BUFFER_SIZE + len(" (%ld bytes)")
>    sprintf(buf, "Opening BINARY mode data connection for %s (%ld bytes)", sess->arg, sbuf.st_size);
>  ...
>   <truncated>
>  ...
>  }
>  Solution: Please use snprintf() to limit maximum input characters.
>  See: https://www.geeksforgeeks.org/snprintf-c-library/
>
> ------------------------------------------
>
> [Vulnerability Type]
> Buffer Overflow
>
> ------------------------------------------
>
> [Vendor of Product]
> https://github.com/Gabe-commiter/Miniftpd
>
> ------------------------------------------
>
> [Affected Product Code Base]
> Miniftpd - Lastest version on github
>
> ------------------------------------------
>
> [Affected Component]
> sprintf() trigger buffer overflow on do_retr() function (from line 706 to 791) on ftpproto.c
>
> ------------------------------------------
>
> [Attack Type]
> Remote
>
> ------------------------------------------
>
> [Impact Denial of Service]
> true
>
> ------------------------------------------
>
> [Attack Vectors]
> Craft a payload with 1024 arg length and then send to application
>
> ------------------------------------------
>
> [Reference]
> https://github.com/Gabe-commiter/Miniftpd/issues/2
>
> ------------------------------------------
>
> [Has vendor confirmed or acknowledged the vulnerability?]
> true

Use CVE-2021-40239.
